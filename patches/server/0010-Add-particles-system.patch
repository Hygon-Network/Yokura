From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Hygon <hygon806@gmail.com>
Date: Thu, 14 Oct 2021 21:48:54 +0200
Subject: [PATCH] Add particles system


diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index 0f22124b7555732c3a05b1eee82a18279a11a861..3c5593661e59ee8cd98b3ce6164a9e5a197877a3 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -5,6 +5,7 @@ import com.google.common.collect.Lists;
 import com.mojang.authlib.GameProfile;
 import com.mojang.datafixers.util.Either;
 import com.mojang.serialization.DataResult;
+import java.util.ArrayList; // Yokura
 import java.util.Collection;
 import java.util.Iterator;
 import java.util.List;
@@ -14,6 +15,7 @@ import java.util.OptionalInt;
 import java.util.Random;
 import java.util.UUID;
 import javax.annotation.Nullable;
+import fr.hygon.yokura.entity.player.ParticleList; // Yokura
 import fr.hygon.yokura.entity.player.Ranks; // Yokura
 import net.minecraft.BlockUtil;
 import net.minecraft.ChatFormatting;
@@ -273,6 +275,9 @@ public class ServerPlayer extends Player {
     public int networkLevel;
 
     public java.util.ArrayList<Ranks> ranks;
+
+    public ParticleList particle;
+    public ArrayList<ParticleList> boughtParticles;
     // Yokura end
 
     public ServerPlayer(MinecraftServer server, ServerLevel world, GameProfile profile, ServerLoginPacketListenerImpl loginPacketListener) { // Yokura - add loginPacketListener
@@ -352,7 +357,11 @@ public class ServerPlayer extends Player {
 
         networkXP = loginPacketListener.networkXP;
         networkLevel = loginPacketListener.networkLevel;
+
         ranks = loginPacketListener.ranks;
+
+        particle = loginPacketListener.particle;
+        boughtParticles = loginPacketListener.boughtParticles;
         // Yokura end
     }
     // Paper start - Chunk priority
@@ -766,6 +775,11 @@ public class ServerPlayer extends Player {
                 this.oldLevel = this.experienceLevel;
             }
             // CraftBukkit end
+            // Yokura start
+            if (this.tickCount % 5 == 0) { // Every 5 ticks
+                particle.getParticle().spawnParticle(getBukkitEntity());
+            }
+            // Yokura end
         } catch (Throwable throwable) {
             CrashReport crashreport = CrashReport.forThrowable(throwable, "Ticking player");
             CrashReportCategory crashreportsystemdetails = crashreport.addCategory("Player being ticked");
diff --git a/src/main/java/net/minecraft/server/network/ServerLoginPacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerLoginPacketListenerImpl.java
index b006c645bab4f386de13fde00f530235d5129b69..c4d526403587b6982b480a7ee3fea4e3534cb95a 100644
--- a/src/main/java/net/minecraft/server/network/ServerLoginPacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerLoginPacketListenerImpl.java
@@ -20,6 +20,7 @@ import javax.crypto.Cipher;
 import javax.crypto.SecretKey;
 import fr.hygon.yokura.YokuraAPI; // Yokura
 import fr.hygon.yokura.config.YokuraGlobalConfig; // Yokura
+import fr.hygon.yokura.entity.player.ParticleList; // Yokura
 import fr.hygon.yokura.entity.player.Ranks; // Yokura
 import net.minecraft.DefaultUncaughtExceptionHandler;
 import net.minecraft.network.Connection;
@@ -81,6 +82,9 @@ public class ServerLoginPacketListenerImpl implements ServerLoginPacketListener
     public int networkLevel;
 
     public ArrayList<Ranks> ranks = new ArrayList<>();
+
+    public ParticleList particle;
+    public ArrayList<ParticleList> boughtParticles;
     // Yokura end
 
     public ServerLoginPacketListenerImpl(MinecraftServer server, Connection connection) {
@@ -480,13 +484,17 @@ public class ServerLoginPacketListenerImpl implements ServerLoginPacketListener
                     .append("tokens", YokuraGlobalConfig.defaultTokens)
                     .append("xp", 0)
                     .append("level", 0)
-                    .append("ranks", new ArrayList<>(Collections.singletonList(Ranks.PLAYER.getPower())));
+                    .append("ranks", new ArrayList<>(Collections.singletonList(Ranks.PLAYER.getPower())))
+                    .append("particle", ParticleList.NONE.toString())
+                    .append("bought_particles", new ArrayList<String>());
 
             coins = YokuraGlobalConfig.defaultCoins;
             tokens = YokuraGlobalConfig.defaultTokens;
             networkXP = 0;
             networkLevel = 0;
             ranks = new ArrayList<>(Collections.singletonList(Ranks.PLAYER));
+            particle = ParticleList.NONE;
+            boughtParticles = new ArrayList<>();
 
             YokuraAPI.getMongoDatabase().getCollection("players").insertOne(playerData);
             ServerLoginPacketListenerImpl.LOGGER.info("Profile for the player " + playerName + " created! (Took " + (System.currentTimeMillis() - startTime) + "ms).");
@@ -496,6 +504,10 @@ public class ServerLoginPacketListenerImpl implements ServerLoginPacketListener
             networkXP = playerData.getInteger("xp");
             networkLevel = playerData.getInteger("level");
             playerData.getList("ranks", Integer.class).forEach(power -> ranks.add(Ranks.getRankFromPower(power)));
+            particle = ParticleList.valueOf(playerData.getString("particle"));
+
+            boughtParticles = new ArrayList<>();
+            playerData.getList("bought_particles", String.class).forEach(boughtParticlesList -> boughtParticles.add(ParticleList.valueOf(boughtParticlesList)));
         }
     }
     // Yokura end
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 36e2a7de001dbb7e890ca4c128c02297219e41fb..fe83bb8458dbdcecfa9255457561629534421889 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -6,6 +6,7 @@ import com.google.common.collect.ImmutableSet;
 import com.google.common.io.BaseEncoding;
 import com.mojang.authlib.GameProfile;
 import fr.hygon.yokura.MongoUtils;  // Yokura
+import fr.hygon.yokura.entity.player.ParticleList; // Yokura
 import fr.hygon.yokura.entity.player.Ranks; // Yokura
 import io.netty.buffer.Unpooled;
 import java.io.ByteArrayOutputStream;
@@ -275,6 +276,38 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         getHandle().ranks.remove(rank);
         MongoUtils.removeFromArrayAsync("players", getUniqueId().toString(), "ranks", rank.getPower());
     }
+
+    @Override
+    public @NotNull ParticleList getParticle() {
+        return getHandle().particle;
+    }
+
+    @Override
+    public void buyParticle(@NotNull ParticleList particle) {
+        getHandle().boughtParticles.add(particle);
+        removeCoins(particle.getPrice());
+        MongoUtils.addToArray("players", getUniqueId().toString(), "bought_particles", particle.toString());
+    }
+
+    @Override
+    public void setParticle(@NotNull ParticleList particle) {
+        if(particle == null) {
+            particle = ParticleList.NONE;
+        }
+
+        getHandle().particle = particle;
+        MongoUtils.updateValueAsync("players", getUniqueId().toString(), "particle", particle.toString());
+    }
+
+    @Override
+    public boolean hasBoughtParticle(@NotNull ParticleList particle) {
+        return getHandle().boughtParticles.contains(particle);
+    }
+
+    @Override
+    public @NotNull List<ParticleList> getBoughtParticles() {
+        return getHandle().boughtParticles;
+    }
     // Yokura end
 
     public GameProfile getProfile() {
